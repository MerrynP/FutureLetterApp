<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Letters to the Future</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Custom security and performance styles */
iframe { display: none !important; }
script[src*="eval"] { display: none !important; }
.rate-limit-notice {
background: #fef3c7;
border: 1px solid #f59e0b;
border-radius: 8px;
padding: 12px;
margin: 16px 0;
color: #92400e;
}
</style>
</head>
<body>
<div id="letters-app"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// Lucide icons as inline SVGs since CDN might not work
const Calendar = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
    <line x1="16" y1="2" x2="16" y2="6"></line>
    <line x1="8" y1="2" x2="8" y2="6"></line>
    <line x1="3" y1="10" x2="21" y2="10"></line>
  </svg>
);

const Clock = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10"></circle>
    <polyline points="12,6 12,12 16,14"></polyline>
  </svg>
);

const Send = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <line x1="22" y1="2" x2="11" y2="13"></line>
    <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
  </svg>
);

const Mail = () => (
  <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path d="m4 4 7.07 7.07a1 1 0 0 0 1.41 0L20 4"></path>
    <path d="m20 4-8.5 8.5a1 1 0 0 1-1.41 0L2 4"></path>
    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
  </svg>
);

const CheckCircle = () => (
  <svg className="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
    <polyline points="22,4 12,14.01 9,11.01"></polyline>
  </svg>
);

const ArrowLeft = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <line x1="19" y1="12" x2="5" y2="12"></line>
    <polyline points="12,19 5,12 12,5"></polyline>
  </svg>
);

const Shield = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
  </svg>
);

const Database = () => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
  </svg>
);

const AlertTriangle = () => (
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
    <line x1="12" y1="9" x2="12" y2="13"></line>
    <line x1="12" y1="17" x2="12.01" y2="17"></line>
  </svg>
);

const LettersToFutureApp = () => {
const [selectedDateOption, setSelectedDateOption] = useState('3months');
const [customDate, setCustomDate] = useState('');
const [letterContent, setLetterContent] = useState('');
const [recipientName, setRecipientName] = useState('');
const [email, setEmail] = useState('');
const [scheduledLetters, setScheduledLetters] = useState([]);
const [showConfirmation, setShowConfirmation] = useState(false);
const [lastScheduledLetter, setLastScheduledLetter] = useState(null);
const [isSubmitting, setIsSubmitting] = useState(false);
const [rateLimitCount, setRateLimitCount] = useState(0);
const [lastSubmitTime, setLastSubmitTime] = useState(0);

// Rate limiting: 5 letters per hour
const RATE_LIMIT = 5;
const RATE_LIMIT_WINDOW = 60 * 60 * 1000; // 1 hour in milliseconds

// Load saved letters from memory/state only (no localStorage)
useEffect(() => {
  // Initialize with empty state - no localStorage access
  setScheduledLetters([]);
  setRateLimitCount(0);
  setLastSubmitTime(0);
}, []);

// Input sanitization
const sanitizeInput = (input) => {
  return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/javascript:/gi, '')
    .replace(/on\w+="[^"]*"/gi, '')
    .trim();
};

// Email validation
const validateEmail = (email) => {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
};

// Rate limiting check
const checkRateLimit = () => {
  const now = Date.now();
  if (now - lastSubmitTime > RATE_LIMIT_WINDOW) {
    setRateLimitCount(0);
    setLastSubmitTime(now);
    return true;
  }
  return rateLimitCount < RATE_LIMIT;
};

const getDeliveryDate = () => {
  const today = new Date();
  switch (selectedDateOption) {
    case '3months':
      return new Date(today.getFullYear(), today.getMonth() + 3, today.getDate());
    case '6months':
      return new Date(today.getFullYear(), today.getMonth() + 6, today.getDate());
    case '1year':
      return new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
    case 'custom':
      return customDate ? new Date(customDate) : null;
    default:
      return null;
  }
};

const formatDate = (date) => {
  if (!date) return '';
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const handleSendLetter = async () => {
  if (!checkRateLimit()) {
    alert('Rate limit exceeded. Please wait before sending another letter.');
    return;
  }

  const deliveryDate = getDeliveryDate();
  const sanitizedContent = sanitizeInput(letterContent);
  const sanitizedName = sanitizeInput(recipientName);
  const sanitizedEmail = sanitizeInput(email);

  if (!deliveryDate || !sanitizedContent.trim() || !sanitizedEmail.trim()) {
    alert('Please fill in all required fields.');
    return;
  }

  if (!validateEmail(sanitizedEmail)) {
    alert('Please enter a valid email address.');
    return;
  }

  if (sanitizedContent.length > 5000) {
    alert('Letter content is too long. Please keep it under 5000 characters.');
    return;
  }

  setIsSubmitting(true);

  const newLetter = {
    id: Date.now() + Math.random(),
    recipient: sanitizedName || 'Future You',
    email: sanitizedEmail,
    content: sanitizedContent,
    deliveryDate: deliveryDate,
    createdAt: new Date(),
    status: 'saved_locally'
  };

  setScheduledLetters([...scheduledLetters, newLetter]);
  setLastScheduledLetter(newLetter);
  setShowConfirmation(true);
  setLetterContent('');
  setRecipientName('');
  setEmail('');
  setIsSubmitting(false);

  // Update rate limiting
  const newCount = rateLimitCount + 1;
  setRateLimitCount(newCount);
  const now = Date.now();
  setLastSubmitTime(now);
};

const handleNewLetter = () => {
  setShowConfirmation(false);
  setLastScheduledLetter(null);
};

const deliveryDate = getDeliveryDate();
const isValidDate = deliveryDate && deliveryDate > new Date();
const remainingRequests = RATE_LIMIT - rateLimitCount;

return (
  <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-4">
    <div className="max-w-2xl mx-auto">
      <div className="text-center mb-8">
        <div className="flex items-center justify-center gap-2 mb-4">
          <Mail />
          <h1 className="text-3xl font-bold text-gray-800">Letters to the Future</h1>
        </div>
        <p className="text-gray-600">Write a letter to your future self and schedule when you'll receive it</p>
        
        {/* Security and Rate Limiting Notice */}
        <div className="mt-4 p-3 bg-green-50 rounded-lg text-sm">
          <div className="flex items-center gap-2 text-green-700 mb-2">
            <Shield />
            <span className="font-medium">Secure & Private</span>
          </div>
          <p className="text-green-600">Your letters are stored securely in your browser session. Rate limited to {RATE_LIMIT} letters per hour.</p>
          <p className="text-green-600 mt-1">Remaining requests: {remainingRequests}</p>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
        {showConfirmation ? (
          // Confirmation Screen
          <div className="text-center py-8">
            <div className="mb-6">
              <CheckCircle className="text-green-500 mx-auto mb-4" />
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Letter Scheduled Successfully!</h2>
              <p className="text-gray-600">Your letter to the future has been processed</p>
            </div>

            <div className="bg-green-50 rounded-lg p-6 mb-6 text-left">
              <h3 className="font-semibold text-green-800 mb-3">Confirmation Details:</h3>
              <div className="space-y-2 text-sm text-green-700">
                <p><strong>Recipient:</strong> {lastScheduledLetter?.recipient}</p>
                <p><strong>Email:</strong> {lastScheduledLetter?.email}</p>
                <p><strong>Delivery Date:</strong> {formatDate(lastScheduledLetter?.deliveryDate)}</p>
                <p><strong>Letter Length:</strong> {lastScheduledLetter?.content.length} characters</p>
                <p><strong>Scheduled:</strong> {formatDate(lastScheduledLetter?.createdAt)}</p>
                <p><strong>Status:</strong> Saved in browser session</p>
              </div>
            </div>

            <div className="bg-blue-50 rounded-lg p-4 mb-6">
              <p className="text-sm text-blue-800">
                <strong>What happens next?</strong><br />
                Your letter has been saved in your browser session. Please set a personal reminder to read your letter on {formatDate(lastScheduledLetter?.deliveryDate)}.
              </p>
            </div>

            <div className="bg-yellow-50 rounded-lg p-4 mb-6">
              <div className="flex items-center gap-2 text-yellow-800 mb-2">
                <AlertTriangle />
                <span className="font-medium">Important Note</span>
              </div>
              <p className="text-sm text-yellow-700">
                This is a demonstration app. Letters are stored temporarily in your browser session only. 
                For permanent storage and email delivery, you would need to integrate with a backend service.
              </p>
            </div>

            <div className="flex gap-3">
              <button
                onClick={handleNewLetter}
                className="flex-1 py-3 px-6 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all flex items-center justify-center gap-2"
              >
                <ArrowLeft />
                Write Another Letter
              </button>
              <button
                onClick={() => window.location.reload()}
                className="flex-1 py-3 px-6 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all"
              >
                Start Over
              </button>
            </div>
          </div>
        ) : (
          // Letter Writing Form
          <>
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-3">
                <Calendar />
                When would you like to receive this letter?
              </label>

              <div className="grid grid-cols-2 gap-3 mb-4">
                <button
                  onClick={() => setSelectedDateOption('3months')}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    selectedDateOption === '3months'
                      ? 'border-purple-500 bg-purple-50 text-purple-700'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  3 Months
                </button>
                <button
                  onClick={() => setSelectedDateOption('6months')}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    selectedDateOption === '6months'
                      ? 'border-purple-500 bg-purple-50 text-purple-700'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  6 Months
                </button>
                <button
                  onClick={() => setSelectedDateOption('1year')}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    selectedDateOption === '1year'
                      ? 'border-purple-500 bg-purple-50 text-purple-700'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  1 Year
                </button>
                <button
                  onClick={() => setSelectedDateOption('custom')}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    selectedDateOption === 'custom'
                      ? 'border-purple-500 bg-purple-50 text-purple-700'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  Custom Date
                </button>
              </div>

              {selectedDateOption === 'custom' && (
                <input
                  type="date"
                  value={customDate}
                  onChange={(e) => setCustomDate(e.target.value)}
                  min={new Date().toISOString().split('T')[0]}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                />
              )}

              {deliveryDate && (
                <div className="mt-3 p-3 bg-blue-50 rounded-lg">
                  <div className="flex items-center gap-2 text-blue-700">
                    <Clock />
                    <span className="font-medium">Delivery Date: {formatDate(deliveryDate)}</span>
                  </div>
                </div>
              )}
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Your Email Address *
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="your.email@example.com"
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                required
                maxLength="100"
              />
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Recipient Name (optional)
              </label>
              <input
                type="text"
                value={recipientName}
                onChange={(e) => setRecipientName(e.target.value)}
                placeholder="Future You"
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                maxLength="50"
              />
            </div>

            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Your Letter (max 5000 characters)
              </label>
              <textarea
                value={letterContent}
                onChange={(e) => setLetterContent(e.target.value)}
                placeholder="Dear Future Me,

Write about your current thoughts, goals, dreams, or anything you'd like to remember. What do you hope to have accomplished by the time you read this? What advice would you give your future self?

With love from the past,
Present You"
                rows={10}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                maxLength="5000"
              />
              <div className="text-right text-sm text-gray-500 mt-1">
                {letterContent.length}/5000 characters
              </div>
            </div>

            <button
              onClick={handleSendLetter}
              disabled={!isValidDate || !letterContent.trim() || !email.trim() || isSubmitting || remainingRequests <= 0}
              className={`w-full py-3 px-6 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${
                isValidDate && letterContent.trim() && email.trim() && !isSubmitting && remainingRequests > 0
                  ? 'bg-purple-600 text-white hover:bg-purple-700 shadow-md hover:shadow-lg'
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              {isSubmitting ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  Processing...
                </>
              ) : (
                <>
                  <Send />
                  Schedule Letter
                </>
              )}
            </button>

            {remainingRequests <= 0 && (
              <div className="mt-3 p-3 bg-red-50 rounded-lg">
                <p className="text-sm text-red-800">
                  <strong>Rate limit reached:</strong> You can send {RATE_LIMIT} letters per hour. Please wait before sending another.
                </p>
              </div>
            )}
          </>
        )}
      </div>

      {scheduledLetters.length > 0 && !showConfirmation && (
        <div className="bg-white rounded-xl shadow-lg p-6">
          <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <Database />
            Your Scheduled Letters ({scheduledLetters.length})
          </h3>
          <div className="space-y-3">
            {scheduledLetters.map((letter) => (
              <div key={letter.id} className="p-4 bg-gray-50 rounded-lg">
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h4 className="font-medium text-gray-800">To: {letter.recipient}</h4>
                    <p className="text-sm text-gray-500">{letter.email}</p>
                  </div>
                  <span className="text-sm text-gray-500">
                    {formatDate(letter.deliveryDate)}
                  </span>
                </div>
                <p className="text-gray-600 text-sm line-clamp-2">
                  {letter.content.length > 100
                    ? letter.content.substring(0, 100) + '...'
                    : letter.content}
                </p>
                <div className="mt-2 flex items-center gap-2">
                  <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <Clock className="w-3 h-3 mr-1" />
                    Saved in Session
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
);
};

ReactDOM.render(<LettersToFutureApp />, document.getElementById('letters-app'));
</script>
</body>
</html>
